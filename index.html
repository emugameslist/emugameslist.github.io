<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Game Catalog</title>
<meta name="description" content="–õ–æ–∫–∞–ª—å–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥ –∏–≥—Ä ‚Äî —Å–∫—Ä–∏–Ω—à–æ—Ç—ã, –æ–ø–∏—Å–∞–Ω–∏–µ –∏ –≤–∏–¥–µ–æ. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–∏—Ç–∞–µ—Ç INI." />
<style>
  :root{
    --bg:#0b0b0d; --panel:#0f1113; --muted:#9aa0a6; --accent:#7dd3fc;
    --card:#111316; --gap:14px; font-family: Inter, Roboto, Arial, sans-serif;
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#070708 0%, #0b0b0d 100%);color:#e6eef6}
  .wrap{max-width:1100px;margin:18px auto;padding:18px;display:grid;grid-template-columns:260px 1fr;gap:18px}
  header{grid-column:1/-1;display:flex;align-items:center;justify-content:space-between;gap:12px}
  header h1{margin:0;font-size:18px}
  .panel{background:var(--panel);border-radius:10px;padding:12px;box-shadow:0 6px 20px rgba(0,0,0,.6)}
  #systems{height:76vh;overflow:auto}
  .sys-btn{display:block;width:100%;text-align:left;padding:10px;border-radius:6px;background:transparent;border:none;color:var(--muted);cursor:pointer;margin-bottom:6px}
  .sys-btn.active{background:linear-gradient(90deg,#062e3a,#08303c);color:#e6f9ff}
  .search{width:100%;padding:10px;border-radius:8px;border:1px solid #222;background:#0b0b0b;color:#e6eef6}
  #game-list{height:60vh;overflow:auto;padding:10px}
  .game-item{padding:10px;border-radius:8px;margin-bottom:8px;background:var(--card);cursor:pointer;border:1px solid rgba(255,255,255,0.02)}
  .game-item:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,.6)}
  .meta{color:var(--muted);font-size:13px;margin-top:6px}
  #details{padding:12px;height:76vh;overflow:auto}
  .tabs{display:flex;gap:8px;margin-bottom:12px}
  .tab{padding:8px 12px;border-radius:8px;background:#0e1112;border:1px solid rgba(255,255,255,.03);cursor:pointer}
  .tab.active{background:linear-gradient(90deg,#08303c,#0b4a55);color:#fff}
  .screens{display:flex;gap:8px;flex-wrap:wrap}
  .screens img{max-width:100%;border-radius:8px;display:block;box-shadow:0 8px 20px rgba(0,0,0,.6)}
  .screenshot-card{width:48%;min-width:220px}
  .info-row{margin-bottom:8px}
  iframe{width:100%;height:360px;border-radius:8px;border:0;background:#000}
  .no-data{color:var(--muted);padding:12px}
  @media(max-width:900px){
    .wrap{grid-template-columns:1fr; padding:10px}
    #systems{height:180px}
    #game-list{height:220px}
    #details{height:auto}
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>üéÆ Game Catalog ‚Äî INI ‚Üí Web</h1>
      <div style="color:var(--muted);font-size:13px">–ê–≤—Ç–æ-–ø–∞—Ä—Å INI ¬∑ –°–∫—Ä–∏–Ω—à–æ—Ç—ã ¬∑ YouTube</div>
    </header>

    <aside class="panel">
      <div style="margin-bottom:10px">
        <label style="color:var(--muted);font-size:13px">–ü–æ–∏—Å–∫ –∏–≥—Ä</label>
        <input id="search" class="search" placeholder="–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é..." />
      </div>

      <div style="margin-bottom:10px">
        <label style="color:var(--muted);font-size:13px">–°–∏—Å—Ç–µ–º—ã</label>
        <div id="systems" style="margin-top:8px"></div>
      </div>

      <div style="margin-top:8px">
        <label style="color:var(--muted);font-size:13px">–ò–≥—Ä—ã</label>
        <div id="game-list" style="margin-top:8px"></div>
      </div>
    </aside>

    <main class="panel" id="details">
      <div id="placeholder">
        <div class="no-data">–í—ã–±–µ—Ä–∏—Ç–µ —Å–∏—Å—Ç–µ–º—É –∏ –∏–≥—Ä—É —Å–ª–µ–≤–∞ ‚Äî –∑–∞—Ç–µ–º –ø–µ—Ä–µ–∫–ª—é—á–∞–π –≤–∫–ª–∞–¥–∫–∏ –°–∫—Ä–∏–Ω—à–æ—Ç—ã / –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è / YouTube.</div>
      </div>

      <div id="game-area" style="display:none">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:8px">
          <div>
            <div id="game-title" style="font-weight:700;font-size:18px"></div>
            <div id="game-sub" class="meta"></div>
          </div>
        </div>

        <div class="tabs" id="tabs">
          <div class="tab active" data-tab="screens">üñºÔ∏è –°–∫—Ä–∏–Ω—à–æ—Ç—ã</div>
          <div class="tab" data-tab="info">‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
          <div class="tab" data-tab="youtube">‚ñ∂Ô∏è YouTube</div>
        </div>

        <div id="tab-screens">
          <div class="screens" id="screens-list"></div>
          <div id="screens-empty" class="no-data" style="display:none">–°–∫—Ä–∏–Ω—à–æ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</div>
        </div>

        <div id="tab-info" style="display:none">
          <div id="info-area"></div>
        </div>

        <div id="tab-youtube" style="display:none">
          <div id="youtube-area"></div>
        </div>
      </div>

    </main>
  </div>

<script>
/* === INI parser (simple, robust for our INI shape) === */
function parseIni(text){
  const result = {}; let section = null;
  // Normalize line endings
  text = text.replace(/\r\n/g,'\n').replace(/\r/g,'\n');
  const lines = text.split('\n');
  for (let raw of lines){
    const line = raw.trim();
    if (!line || line.startsWith(';') || line.startsWith('#')) continue;
    const sect = line.match(/^\[(.+?)\]$/);
    if (sect){
      section = sect[1];
      result[section] = {};
      continue;
    }
    if (!section) continue;
    const kv = line.split('=');
    if (kv.length >= 2){
      const key = kv[0].trim();
      const val = kv.slice(1).join('=').trim();
      result[section][key] = val;
    }
  }
  return result;
}

/* === utils to fetch INI files from data/ === */
async function fetchIniFile(path){
  try{
    const r = await fetch(path, {cache:'no-cache'});
    if (!r.ok) return null;
    const txt = await r.text();
    return parseIni(txt);
  }catch(e){
    return null;
  }
}

/* === load systems and populate UI === */
const systemsEl = document.getElementById('systems');
const gameListEl = document.getElementById('game-list');
const searchInput = document.getElementById('search');

let currentSystemDir = null;
let allGames = []; // merged list for current system
let shownGames = [];
let currentGame = null;

async function init(){
  const systems = await fetchIniFile('data/Systems.ini');
  systemsEl.innerHTML = '';
  if (!systems){
    systemsEl.innerHTML = '<div style="color:#f88">–ù–µ –Ω–∞–π–¥–µ–Ω data/Systems.ini</div>';
    return;
  }
  // sections are system display names
  const names = Object.keys(systems);
  for (let i=0;i<names.length;i++){
    const sec = names[i];
    const dir = systems[sec]['Dir'] || sec;
    const btn = document.createElement('button');
    btn.className = 'sys-btn';
    btn.textContent = sec;
    btn.dataset.dir = dir;
    btn.onclick = () => selectSystem(btn);
    systemsEl.appendChild(btn);
    // select first by default
    if (i===0){ selectSystem(btn); }
  }
}

function clearActiveSys(){
  document.querySelectorAll('.sys-btn').forEach(b=>b.classList.remove('active'));
}

async function selectSystem(button){
  clearActiveSys();
  button.classList.add('active');
  currentSystemDir = button.dataset.dir;
  // Load INI files for the selected system
  await loadGamesForSystem(currentSystemDir);
}

/* === load and merge Games.ini / Emulators.ini / Demos.ini === */
async function loadGamesForSystem(systemDir){
  // try at root: data/Games.ini etc OR under per-system folder data/<systemDir>/Games.ini
  // We'll attempt both locations.
  const candidates = [
    `data/Games.ini`,
    `data/Emulators.ini`,
    `data/Demos.ini`,
    `data/${encodeURIComponent(systemDir)}/Games.ini`,
    `data/${encodeURIComponent(systemDir)}/Emulators.ini`,
    `data/${encodeURIComponent(systemDir)}/Demos.ini`
  ];
  const merged = {};
  // fetch each unique path only once
  const tried = new Set();
  for (const p of candidates){
    if (tried.has(p)) continue;
    tried.add(p);
    const data = await fetchIniFile(p);
    if (!data) continue;
    for (const sec of Object.keys(data)){
      // keep last read wins ‚Äî but we key by section name + source path to avoid collisions
      merged[`${p}||${sec}`] = data[sec];
    }
  }
  // Now flatten into array and filter by system matching heuristic
  const arr = Object.values(merged).map(obj => {
    // normalize keys: prefer Name, Dir, Year, Rating, Comment, Found
    return {
      Name: obj['Name'] || obj['NAME'] || obj['name'] || '',
      Dir: obj['Dir'] || obj['DIR'] || obj['dir'] || '',
      Year: obj['Year'] || obj['year'] || '',
      Rating: obj['Rating'] || obj['rating'] || '',
      Comment: obj['Comment'] || obj['COMMENT'] || '',
      Found: obj['Found'] || obj['found'] || ''
    };
  });

  // Heuristic: choose games that are for the chosen system.
  // Cases covered:
  // 1) Dir begins with systemDir
  // 2) Dir contains systemDir
  // 3) If none matched, show all (fallback)
  const sys = systemDir.toLowerCase();
  const matches = arr.filter(g => {
    if (!g.Dir && !g.Name) return false;
    const d = (g.Dir || '').toLowerCase();
    const n = (g.Name || '').toLowerCase();
    if (d.startsWith(sys)) return true;
    if (d.includes(sys)) return true;
    // sometimes Dir is like "Apple I BASIC" while systemDir is "Apple I" -> include
    if (sys && d.split(' ').some(tok=>sys.includes(tok) || tok.includes(sys))) return true;
    // sometimes Dir empty but name contains system name ‚Äî optional
    return false;
  });

  allGames = (matches.length>0 ? matches : arr).map((g, idx) => ({
    id: idx,
    name: g.Name,
    dir: g.Dir,
    year: g.Year,
    rating: g.Rating,
    comment: g.Comment,
    found: g.Found
  }));

  renderGameList();
}

/* === render games and search === */
function renderGameList(){
  const q = (searchInput.value||'').toLowerCase();
  shownGames = allGames.filter(g => (g.name||'').toLowerCase().includes(q));
  gameListEl.innerHTML = '';
  if (shownGames.length===0){
    gameListEl.innerHTML = '<div class="no-data">–ò–≥—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</div>';
    return;
  }
  for (const g of shownGames){
    const el = document.createElement('div');
    el.className = 'game-item';
    el.innerHTML = `<div style="font-weight:600">${escapeHtml(g.name)}</div>
      <div class="meta">${escapeHtml(g.dir)} ${g.year ? ' ‚Ä¢ ' + g.year : ''} ${g.rating ? ' ‚Ä¢ ‚≠ê'+g.rating : ''}</div>`;
    el.onclick = () => showGame(g);
    gameListEl.appendChild(el);
  }
}

/* === show game details (tabs, screenshots, info, youtube) === */
function showGame(g){
  currentGame = g;
  document.getElementById('placeholder').style.display='none';
  document.getElementById('game-area').style.display='block';
  document.getElementById('game-title').textContent = g.name || '(–±–µ–∑ –∏–º–µ–Ω–∏)';
  document.getElementById('game-sub').textContent = `${g.dir || ''} ${g.year ? ' ‚Ä¢ ' + g.year : ''}`;
  // Info
  const info = document.getElementById('info-area');
  info.innerHTML = `
    <div class="info-row"><strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong> ${escapeHtml(g.name)}</div>
    <div class="info-row"><strong>–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è / –î–∞—Ç–∞:</strong> ${escapeHtml(g.dir)} ${g.year ? ' ‚Ä¢ ' + escapeHtml(g.year) : ''}</div>
    <div class="info-row"><strong>–†–µ–π—Ç–∏–Ω–≥:</strong> ${escapeHtml(g.rating || '‚Äî')}</div>
    <div class="info-row"><strong>–ù–∞–π–¥–µ–Ω–æ:</strong> ${escapeHtml(g.found || '‚Äî')}</div>
    <div class="info-row"><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> ${escapeHtml(g.comment || '')}</div>
  `;

  // Screenshots: try multiple extensions and index 1..8
  const screensList = document.getElementById('screens-list');
  screensList.innerHTML = '';
  const base = g.dir || g.name || '';
  const extCandidates = ['png','jpg','jpeg','webp'];
  let foundAny = false;
  for (let i=1;i<=8;i++){
    for (const ext of extCandidates){
      const path = `data/screenshots/${encodeURIComponent(base)}_${i}.${ext}`;
      // create image with onload/onerror to detect existence
      const img = new Image();
      img.dataset.tryPath = path;
      img.style.display = 'none';
      img.onload = () => {
        foundAny = true;
        img.style.display = 'block';
        // place into small card wrapper
        const card = document.createElement('div');
        card.className = 'screenshot-card';
        card.appendChild(img);
        // add click to open full
        img.style.cursor='pointer';
        img.onclick = () => window.open(path, '_blank');
        screensList.appendChild(card);
        document.getElementById('screens-empty').style.display = 'none';
      };
      img.onerror = () => {
        // nothing, try next ext
      };
      img.src = path;
    }
  }
  // Wait a small moment and if none loaded, show empty
  setTimeout(()=> {
    if (!screensList.children.length) {
      document.getElementById('screens-empty').style.display = 'block';
    } else {
      document.getElementById('screens-empty').style.display = 'none';
    }
  }, 600);

  // YouTube tab: embed a search results playlist for "NAME gameplay"
  const yt = document.getElementById('youtube-area');
  const q = encodeURIComponent((g.name || '') + ' gameplay');
  yt.innerHTML = `<iframe src="https://www.youtube.com/embed?listType=search&list=${q}" allowfullscreen></iframe>`;
}

/* === simple tab handling === */
document.getElementById('tabs').addEventListener('click', (e)=>{
  const t = e.target.closest('.tab');
  if (!t) return;
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  const tabName = t.dataset.tab;
  document.getElementById('tab-screens').style.display = tabName==='screens' ? 'block' : 'none';
  document.getElementById('tab-info').style.display = tabName==='info' ? 'block' : 'none';
  document.getElementById('tab-youtube').style.display = tabName==='youtube' ? 'block' : 'none';
});

/* === search handler === */
searchInput.addEventListener('input', () => renderGameList());

/* === utils === */
function escapeHtml(s){
  if (!s) return '';
  return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
}

/* === init on page load === */
init();
</script>
</body>
</html>
